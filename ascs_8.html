<!DOCTYPE html>
<meta charset="UTF-8">
<!--
	version 1_b: hits from front, sides, rear are properly counted 
	version 1_c: added: explosion when ship is destroyed
	-- Explosion elements are cleaned up at the start of turn 
	version 2: direction arrow is changed into a function 
	version 3: added target line 
	version 3a: added function that creates a shortened line between two points 
	version 3b: fixed bug where the above line would point to the position fleet_x had last turn
	version 3b_i: merged functions: draw_target_line --- shortened_line 
	version 4: Split fleet in Core and ring
	version 5: Ship damage Display
	version 6:  - Destroyed Ships are deleted from the fleet list 
				- Fleets "die" when they have no ships left  
	version 7: Multiple Fleets 
				7a: - changed variable name: active_player_fleet => active_player_fleet 
					- => added new variable : active_enemey_fleet 
					7a_i: - added cleanup function that removes a dead fleets graphics at the end of turn
					7a_ii: changed the update_target_angle function : split of the angle calculations into a seperate function 
					7a_iv: circumventet the problem that $watch active_player_fleet causes error:  
						=> The turn button updates the target_lines 
-->
<html>
<head> 
	<title> ANCS </title>
	<script src="jquery-3.1.1.js"></script>
	<script src="angular.min.js"> </script>
	<script src="xfunctions.js"> </script>
	<script src="ships.js"> </script>
	<style>
		
		
		.black_line_h {
			position:relative;
			width:100%;
			height:1px;
			background-color:black;
		}
		
		.black_line_v {
			position:relative;
			width:1px;
			height:100%;
			background-color:black;
		}
		
		
		
		#windows_frame {
			position:absolute;
			width:100%;
			height:100vh;
			right:0px;
			top:0px;
			box-sizing:border-box;
			background-image:url("cloud_metal.png");
			background-size:50% 50%;
			///// background:linear-gradient(to bottom right, rgb(100,100,255),white,rgb(100,100,255),white,rgb(100,100,255),white,rgb(100,100,255),white,rgb(100,100,255),white,rgb(100,100,255));
			
			
			box-shadow:
				inset 0 0 0 1px #000,
				inset 0 0 0 2px #ddd;
			border-radius:10px;
			padding:10px;
		
		}
		
		#inner_windows_frame {
			width:100%;
			height:100%;
			position:relative;
			display:flex;
			flex-direction:column;
			padding:2px;
			box-shadow:
				inset 0 0 0 1px #ddd,
				inset 0 0 0 2px #40434a;
		
		}
		
			#main_menu_bar {
				background-color: #828282;
				border:1px solid;
				border-left-color:#9a9a9a;
				border-top-color:#9a9a9a;
				border-right-color:#6c6c6c;
				border-bottom-color:#6c6c6c;
			
			}
			
				.menu_button {
					position:relative;
					width:50px;
					height:100%;
					color:white;
					border:1px solid black;
					box-sizing:border-box;
					padding:5px;
					margin-right:10px;
					overflow:hidden;
				}
			
				#battle_button {
				}
		
				#design_button {
				}
				
			
			
			.battle_design_frame {
				width:100%;
				height:80%;
				position:relative;
				display:flex;
				flex-grow:1;
				flex-direction:column;
			}
			
			#design_frame {
				display:flex;
				flex-direction:row;
				overflow-x:scroll;
				
			}
				.design_column {
					width:500px;
					height:100%;
					display:flex;
					flex-direction:column;
					overflow-y:scroll;
					background-color: #686868;
					border:1px solid;
					border-left-color:#7a7a7a;
					border-top-color:#7a7a7a;
					border-right-color:#5c5c5c;
					border-bottom-color:#5c5c5c;
					opacity:0.9;
				}
					
					.column_row {
						display:flex;
						flex-direction:row;
					}
					
						.row_field {
							width:100px;
							padding-left:5px;
							padding-right:5px;
						
						}
				
				.design_column_spacer {
					position:relative;
					width:20px;
					height:100%;
					flex-grow:1;
					
				}
			
			#battle_frame {
			}
		
			
		
				#header_row {
					position:relative;
					height:100px;
					width:100%;
					padding:5px 5px 5px 5px;
					background-color: #686868;
					border:1px solid;
					border-left-color:#7a7a7a;
					border-top-color:#7a7a7a;
					border-right-color:#5c5c5c;
					border-bottom-color:#5c5c5c;
					border-bottom-color:#5c5c5c;
					box-sizing:border-box;
					display:flex;
					flex-direction:column;
				}
				
					.header_bar {
						position:relative;
						box-sizing:border-box;
						height:50px;
						width:100%;
						padding:2px 5px 2px 5px;
						display:flex;
						flex-direction:row;
						
						border:1px solid;
						border-left-color:#7a7a7a;
						border-top-color:#7a7a7a;
						border-right-color:#5c5c5c;
						border-bottom-color:#5c5c5c;
						
					}
					
						#turn_button {
							position:relative;
							width:50px;
							height:100%;
							color:white;
							border:1px solid black;
							box-sizing:border-box;
							padding:5px;
						}
						
						
						.ship_display_small {
							position:relative;
							width:100px;
							height:100%;
							border:1px solid black;
							padding:2px;
							display:flex;
							flex-direction:row;
						} 
						
							.ship_display_inner { 
								position:relative;
								width:40px;
								flex-grow:1;
								height:100%;
								padding-left:3px;
								display:flex;
								flex-direction:column;
								font-size:10px;
							} 
							
								.small_bar {
									position:relative;
									width:40px;
									height:4px;
									margin-top:3px;
									margin-bottom:3px;
									background-color:red;
								}
								
									.small_bar_inner {
										position:relative;
										width:40px;
										height:4px;
										background-color:green;
									}
									
								.turret_display {
									position:relative;
									width:100%;
									height:12px;
									display:flex;
									flex-direction:row;
								
								}
								
								
								
									.cx_turret_ok {
										position:relative;
										width:10px;
										height:10px;
										background-image:url("green_button.png");
										background-size:100% 100%;
									}
									
									.cx_turret_dead {
										position:relative;
										width:10px;
										height:10px;
										background-image:url("red_button.png");
										background-size:100% 100%;
									}
								
									.main_turret_ok {
										position:relative;
										width:8px;
										height:8px;
										background-image:url("green_button.png");
										background-size:100% 100%;
									}
									
									.main_turret_dead {
										position:relative;
										width:8px;
										height:8px;
										background-image:url("red_button.png");
										background-size:100% 100%;
									}
									
									.secondary_turret_ok {
										position:relative;
										width:5px;
										height:5px;
										background-image:url("green_button.png");
										background-size:100% 100%;
									}
									
									.secondary_turret_dead {
										position:relative;
										width:5px;
										height:5px;
										background-image:url("red_button.png");
										background-size:100% 100%;
									}
					
					
				
				#middle_row {
					position:relative;
					height:70%;
					width:100%;
					background-color:green;
					flex-grow:1;
					display:flex;
					flex-direction:row;
				
				}
				
				
				#footer_row {
					position:relative;
					height:100px;
					width:100%;
					padding:5px 5px 5px 5px;
					background-color: #686868;
					border:1px solid;
					border-left-color:#7a7a7a;
					border-top-color:#7a7a7a;
					border-right-color:#5c5c5c;
					border-bottom-color:#5c5c5c;
					box-sizing:border-box;
					display:flex;
					flex-direction:row;
				}
				
				
				
				
				#left_column {
					width:250px;
					height:100%;
					
					padding:5px 5px 5px 5px;
					background-color: #828282;
					border:1px solid;
					border-left-color:#9a9a9a;
					border-top-color:#9a9a9a;
					border-right-color:#6c6c6c;
					border-bottom-color:#6c6c6c;
					box-sizing:border-box;
					background:url("knob_bg.png");
					overflow-y:scroll;
				}
				
				#middle_column {
					box-sizing:border-box;
					position:relative;
					width:1px;
					
					height:100%;
					flex-grow:1;
					border:1px solid;
					background:url("space.png");
					background-size:100% 100%;
					border-left-color:#505050;
					border-top-color:#505050;
					border-right-color:#252525;
					border-bottom-color:#252525;
					overflow:hidden;
					
				}
				
					.fleet_button {
						position:absolute;
						top:-50px;
						left:-50px;
						margin-left:-7px;
						margin-top:-7px;
						height:14px;
						width:14px;
						background:url("green_button.png");
						background-size:100% 100%;
					
					}
					
					
					
					#fleet_b {
						position:absolute;
						top:-50px;
						left:200px;
						height:15px;
						width:15px;
						background:url("red_blip_2.png");
						background-size:100% 100%;
					
					}
					
					#fleet_c {
						position:absolute;
						top:-50px;
						left:300px;
						height:15px;
						width:15px;
						background:url("red_circle.svg");
						background-size:100% 100%;
					
					}
					
					
					#fleet_x {
						position:absolute;
						top:-50px;
						left:300px;
						margin-left:-7px;
						margin-top:-7px;
						height:14px;
						width:14px;
						background:url("red_button.png");
						background-size:100% 100%;
					}
					
					
					.small_explosion {
						position:absolute;
						width:100px;
						height:100px;
					
					}
					
					.orange_shot {
						position:absolute; 
						margin-left:-2px;
						margin-top:-2px;
						height:4px;
						width:4px;
						background:url("orange_button.png");
						background-size:100% 100%;
					}
					
					.orange_test {

						position:absolute;
						font-size:10px;						
						padding:10px;
						height:100px;
						width:100px;
						
						background-size:100% 100%;
						
						background-color:#aee; 
						
						<!-- 
						border-color:#0cc;
						box-shadow:inset 0 1px 0 #bbffff;
						--> 
						box-shadow:
							inset 0 0 1 1px #000,
							inset 0 0 0 2px #ddd,
							inset 0 0 0 10px #88f,
							inset 0 0 0 11px #ddd,
							inset 0 0 0 12px #40434a;
							
						border-radius:6px;
					}
					
					.b17 {
						position:absolute;
						height:100px;
						width:100px;
						font-size:10px;
						border-radius:10px;
						background-image:url("alu_plate.png");
						background-size:100% 100%;
						// border-radius:2px;
						#border:1px solid;
						// background-color:#0095ff;
						// background:linear-gradient(#0095ff, #ccc, #0095ff );
						#border-color:#07f;
						// box-shadow: inset 0 0 0 1px red;
						box-shadow: inset 0 0 0 1px #ddd, 
									inset 0 0 0 2px #40434a;
						
						color:#0095ff;
						padding:5px 5px 5px 5px;
						box-sizing:border-box;
						display:flex;
						flex-direction:column; 
					}
					
						.display_hits_field_column {
							flex-grow:1; 
							display:flex;
							flex-direction:row; 
						}
						
							.display_hits_field_column_left {
								flex-grow:4;  
							}
							
							.display_hits_field_column_right {
								flex-grow:1;  
								padding-right:4px; 
								text-align:right;
							}
					
					
					


					.small_yellow_ring {
						position:absolute; 
						margin-left:-5px;
						margin-top:-5px;
						height:10px;
						width:10px;
						background:url("yellow_ring.gif");
						background-size:100% 100%;
					}
					
				#right_0_column {
					position:relative;
					width:15%;
					height:100%;
					background-color:#727272;
					padding:5px 5px 5px 5px;
					background-color: #686868;
					border:1px solid;
					border-left-color:#9a9a9a;
					border-top-color:#7a7a7a;
					border-right-color:#5c5c5c;
					border-bottom-color:#5c5c5c;
					box-sizing:border-box;
					overflow-y:scroll;
					
				
				
				}
					
				
				#right_column {
					position:relative;
					width:15%;
					height:100%;
					background-color:#727272;
					padding:5px 5px 5px 5px;
					background-color: #686868;
					border:1px solid;
					border-left-color:#9a9a9a;
					border-top-color:#7a7a7a;
					border-right-color:#5c5c5c;
					border-bottom-color:#5c5c5c;
					box-sizing:border-box;
					overflow-y:scroll;
					
				
				
				}
				
				
				#direction_speed_container {
					height:100px;
					position:relative;
					box-sizing:border-box;
					display:flex;
					flex-direction:row;
					border-style:ridge;
					border-color:grey;
					margin-bottom:10px;
				
				}
				
				
					#select_direction {
						position:relative;
						box-sizing:border-box;
						width:83px;
						height:100px;
						background:url("knob_1.png");
						float:left;
					}
					
						#point_set {
							position:absolute;
							box-sizing:border-box;
							width:10px;
							height:10px;
							background:url("point.png");
							top:35px;
							left:35px;
						
						}
						
						#point_current {
							position:absolute;
							box-sizing:border-box;
							width:10px;
							height:10px;
							background:url("point_blue.png");
							top:35px;
							left:35px;
						
						}
						
						#display_course_number {
							position:relative;
							width:60px;
							height:100%;
							display:flex;
							flex-direction:column;
							border:1px solid grey;
						}
							
							#display_current_course {
								position:relative;
								padding:2px 5px 4px 5px;
								color:white;
								text-align:center;
								height:50%;
								width:100%;
								border:1px solid;
							}
							
							#display_set_course {
								padding:2px 5px 4px 5px;
								color:white;
								text-align:center;
								position:relative;
								height:50%;
								width:100%;
								border:1px solid;
							}
						
						
						#up_down {
							height:100%;
							width:36px;
							padding:10px 5px 10px 5px;
							box-sizing:border-box;
							position:relative;
							display:flex;
							flex-direction:column;
						}
						
							#up {
								height:30px;
								width:26px;
								background:url("up.png");
							}
							
							
							#down {
								height:30px;
								width:26px;
								background:url("down.png");
							}
					
					
					
				
					#player_ship_list {
						position:relative; 
						width:100%;
						
					}
					
						.ship_display {
							width:100%;
							border-style:ridge;
							overflow:hidden;
							color:white;
							display:flex;
							flex-direction:column;
							flex-grow:1; 
							flex-shrink:1;
							margin-bottom:10px;
						}
						
							.name_type {
								position:relative;
								width:100%;
								height:20px;
								overflow:hidden;
								display:flex;
								flex-direction:row;
							}
							
								.name {
									position:relative;
									height:100%;
									width:60%;
									flex-grow:1;
									padding-left:5px;
								}
								
								.type {
									position:relative;
									height:100%;
									width:30px;
									padding-right:5px;
									text-align:right;
								}
							
							.hp_guns {
								position:relative;
								width:100%;
								height:20px;
								overflow:hidden;
								
								display:flex;
								flex-direction:row;
							}
							
								.hp {
									position:relative;
									width:100px;
									height:100%;
									padding-left:5px;
								}
								
								.guns {
									position:relative;
									height:100%;
									width:60%;
									flex-grow:1;
									padding-right:5px;
									text-align:right;
								}
					
						.arc {
							position:relative;
							width:100px;
							height:100%;
							padding-left:5px;
							display:flex;
							flex-direction:row;
						}
							
							.green_light {
								position:relative;
								float:right;
								height:10px;
								width:10px;
								margin-top:7px;
								margin-left:10px;
								background:url("green_button.png");
								background-size:100% 100%;
							}
							
							.red_light {
								position:relative;
								float:right;
								height:10px;
								width:10px;
								margin-top:7px;
								margin-left:10px;
								background:url("red_button.png");
								background-size:100% 100%;
							}
						
						.escort_display {
							width:100%;
							height:200px;
							border:2px ridge aqua;
							color:black;
							display:flex; 
							flex-direction:column; 
						}
						
							
							.escort_display_symbol {
								height:8px; 
								width:8px; 
								margin:2px;
								background:url("yellow_button2.png");
								background-size:100% 100%;
							}
							
							
							
							.escort_display_send_to_middle {
								height:20px;
								width:100%;
								background-color:orange;
								border:2px ridge aqua; 
								display:flex;
								flex-direction:row; 
								font-size:10px;
							}
							
								.escort_display_send_to_middle_number {
									height:100%; 
									width:20px; 
									flex-grow:1;
									background-color:grey; 
									border:1px solid green;
									text-align:center;
								}
							
							
							
							.escort_display_top_row {
								height:50px; 
								// background-color:blue; 
								margin-left:50px;
								margin-right:50px;
								display:flex;
								flex-direction:row; 
								flex-wrap:wrap;
								border:2px ridge aqua;
								border-radius:5px;
							}
							
							.escort_display_middle_row {
								height:1px; 
								background-color:green; 
								flex-grow:1; 
								display:flex;
								flex-direction:row;
							}
							
								.escort_display_left_column {
									height:100%; 
									width:50px;
									display:flex;
									flex-direction:column;
									flex-wrap:wrap;
									border:2px ridge aqua;
									border-radius:5px;
								}
								
								.escort_display_middle_column {
									height:100%; 
									width:1px;
									flex-grow:1;
									background-color:black; 
									display:flex;
									flex-direction:column; 
								}
								
									.escort_display_middle_column_top_row {
										width:100%; 
										height:1px; 
										flex-grow:2; 
										background-color:aqua; 
										display:flex;
										flex-direction:row; 
										flex-wrap:wrap;
									}
									
									
									
									.escort_display_middle_column_bottom_row {
										width:100%; 
										height:1px; 
										flex-grow:1; 
										background-color:orange; 
									}
								
									.escort_display_distance {
										height:20px;
										width:100%;
										background-color:orange;
										border:2px ridge aqua; 
										display:flex;
										flex-direction:row; 
										font-size:10px;
									}
									
										.escort_display_distance_number {
											height:100%;
											width:40px;
											background-color:green;
											border:2px ridge grey; 
											flex-grow:1; 
											text-align:center;
										}
										
										
								
								.escort_display_right_column {
									height:100%; 
									width:50px;
									display:flex;
									flex-direction:column;
									flex-wrap:wrap;
									border:2px ridge aqua;
									border-radius:5px;
								}
							
							
							.escort_display_bottom_row {
								height:50px; 
								margin-left:50px;
								margin-right:50px;
								display:flex;
								flex-direction:row;
								flex-wrap:wrap;
								border:2px ridge aqua;
								border-radius:5px;
							}
	</style>
		
		
	
	
	
	
	<script> 
	
	var app = angular.module ("mainApp", [] )
	
	app.directive ("healthBar", function () {
		return {
			link: function ($scope, element, attrs) {
				
				
			$scope.$watch ( function () {
				return $scope.ship.hitpoints_q 
			},
			function  (newVal, oldVal, $scope)  {
				$(element).css ("width", $scope.ship.hitpoints_q +"px"  )  
			})
				
			}
		}
	})
	
	app.directive ("engineBar", function () {
		return {
			link: function ($scope, element, attrs) {
				
				
			$scope.$watch ( function () {
				return $scope.ship.engine_hitpoints_q 
			},
			function  (newVal, oldVal, $scope)  {
				$(element).css ("width", $scope.ship.engine_hitpoints_q +"px"  )  
			})
		
				
				
				
			}
		}
	})
	
	app.directive ("assignCommands", function () {
		return {
			link: function ($scope, element, attrs ) {
			}
			////////////////////////
		
		}
	})
	///////////////////////////////////////////////////
	app.directive('changeWidth', function(){
		return function(scope, element, attrs){
			attrs.$observe('backImg', function(value) {
				element.css({
					'background': 'transparent url(' + value +')'
				});
			});
		};
	});
	
	
	//////////////////////////////////////////
	function concat_object_values (my_object) {
		var result = []; 
		Object.keys (my_object).forEach (function (key, index) {
			var value = my_object[key]; 
			result = result.concat (value);  
		})
		return result 
	}
	
	
	///////////////////////////////////////////
	
	function makeSVG(tag, attrs) {
		var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
		for (var k in attrs)
			el.setAttribute(k, attrs[k]);
		return el;
    }
	///////////////////////////////////////////////////
	
	function log_once (stuff) {
		console.log (stuff); 
		log_once = undefined; 
	}
	
	///////////////////////////////////////////////////
	
	function dlog2 (content, test_message) {
		console.log (test_message) 
		console.log (content) 
	}
	
	///////////////////////////////////////////////////
	function xround (x,n) {
		var factor = 10 ** n
		x = x * factor 
		x = Math.round (x)
		x = x / factor 
		return x 
	}
	///////////////////////////////////////////////////
	
	///////////////////////////////////////////////////
	function vround (v,n) {
		new_vector = []
		for (let item of v) {
			new_vector.push ( xround (item, n))
		}
		
		return new_vector 
	}
	///////////////////////////////////////////////////
	
	///////////////////////////////////////////////////
	function point_to_string (point) {
		return point [0] + "," + point [1]
		
	}
	///////////////////////////////////////////////////
	
	
	
	
	////////////////////////////////////////////////
	function random_n (n) {
		return Math.floor ( (n + 1) * Math.random ())   
	
	}
	
	
	//////////////
	function vadd (a,b) {
		return [a [0] + b [0], a [1] + b [1]] 
	}
	///////////
	
	//////////////
	function vsub (a,b) {
		return [a [0] - b [0], a [1] - b [1]] 
	}
	///////////
	
	///////////
	function vector_length (v) {
		var a = v [0]
		var b = v [1]
		
		return ( (a ** 2) +  (b ** 2) ) ** 0.5 
	}
	/////////////
	
	///////////////////////////////////////
	normalize_angle = function (a) {
		if (a < -3.14) {
			a += 6.28
		}
		if (a > 3.14) {
			a -= 6.28
		}
		return a 
	}
	///////////////////////////////////////
	
	///////////////////////////////////////
	function angle_go_left (old_angle, move) {
		var new_angle = normalize_angle (old_angle + move )
		return new_angle
	}
	/////////////
	
	///////////////////////////////////////
	function angle_go_right (old_angle, move) {
		var new_angle = normalize_angle (old_angle - move )
		return new_angle
	}
	/////////////
	
	
	
	/////////////
	function between_dict (dict, x) {
		for (var k in dict) {
			range = k.split ('-')
			if ( (x >= parseInt (range [0]))  && (x <= parseInt (range [1]) )) {
				return dict [k]
			
			}
		}
	}
	////////////
	function extrapolate_line (point, start_distance, end_distance, alpha) {
		
		var sp_x = point [0] + start_distance * Math.sin (alpha) 
		var sp_y = point [1] + start_distance * Math.cos (alpha) 
		
		var ep_x = point [0] + end_distance * Math.sin (alpha) 
		var ep_y = point [1] + end_distance * Math.cos (alpha)
		
		return {"start": [sp_x, sp_y], "end": [ep_x, ep_y]}
	}
	////////////////////////////////////////////////////
	
	////////////////////////////////////////////////////
	function dot (point) {
		var circle= makeSVG('circle', {cx: point [0], cy: point [1], r:2, stroke: 'black', 'stroke-width': 0, fill: 'white'});
		$("#canvas").append (circle)
		$("#middle_column").append ( $("<div> </div>").addClass ("orange_shot")) 
	}
	
	////////////////////////////////////////////////////
	
	
	
	/////////////////////////////////////////////////////
	function draw_target_line (fleet_1, fleet_2, $scope) {
		if (! ( ($scope.display_target_lines_fleets.includes (fleet_1) ) && ($scope.display_target_lines_fleets.includes (fleet_2) )      )              ) {
			return false 
		}
		
		
		
		// shortened_line (fleet_1.position, fleet_2.position, 10, 0.2) 
		var point_1 = fleet_1.position
		var point_2 = fleet_2.position
		var padding = 14
		var stroke_width = 0.2
		
		
		var theta = Math.atan2.apply (this, vsub (point_2, point_1))
		var full_length = vector_length ( vsub (point_2, point_1))
		
		var line = extrapolate_line (point_1, padding, full_length - padding, theta) 
		
		var sp_x = line.start [0]
		var sp_y = line.start [1]
		
		var ep_x = line.end [0]
		var ep_y = line.end [1]
		
		var line_graphic = makeSVG('line', {"class": "graphic", x1: sp_x, y1: sp_y, x2: ep_x, y2: ep_y, stroke: 'white', 'stroke-width': stroke_width});
		line_graphic.classList.add (fleet_1.name)
		line_graphic.classList.add (fleet_2.name)
		$("#canvas").append (line_graphic)
		
		
		////// 			get angles
		//// 	angle 1 	
			
		//		Get target course
		var a = fleet_1.current_course
		
		var ps = fleet_1.position 
		var pe = fleet_2.position 
		
		var rel_pos = vsub (pe, ps) 
		var b = Math.atan2 (rel_pos [0], rel_pos [1])
		
		//		Get relative angle 
		var alpha = b - a 
		
		if (alpha < 0) {
			alpha += 6.28
		}
	
		if (alpha > 6.29) {
			alpha -= 6.28
		}
		
		alpha = xround (alpha, 3)
		
		
		var fleet_angle_1 = xround (57.3 * alpha, 0)
		
		////////////////////
		////	angle 2 
		//		Get target course
		var a = fleet_2.current_course
		
		var ps = fleet_2.position 
		var pe = fleet_1.position 
		
		var rel_pos = vsub (pe, ps) 
		var b = Math.atan2 (rel_pos [0], rel_pos [1])
		
		//		Get relative angle 
		var alpha = b - a 
		
		if (alpha < 0) {
			alpha += 6.28
		}
	
		if (alpha > 6.29) {
			alpha -= 6.28
		}
		
		alpha = xround (alpha, 3)
		
		
		var fleet_angle_2 = xround (57.3 * alpha, 0)
		
		
		
		
		//////
		
		var angle = $("<div></div>").css ("position", "absolute").css ("left", sp_x - 8).css ("top", sp_y -8).html (fleet_angle_1).attr ("id", "angle_1").css("color", "white").css("font-size",10).addClass ("graphic").addClass (fleet_1.name).addClass (fleet_2.name) 
		
		$("#middle_column").append (angle)
		
		var angle2 = $("<div></div>").css ("position", "absolute").css ("left", ep_x - 8).css ("top", ep_y -8).html (fleet_angle_2).attr ("id", "angle_1").css("color", "white").css("font-size",10).addClass ("graphic").addClass (fleet_1.name).addClass (fleet_2.name)  
		
		$("#middle_column").append (angle2)
	}
	///////////////////////////////////////////////////////
	
	
	
	
	////////////////////////////////////////////////////
	
	////////////////////////////////////////////////////
	function draw_speed_arrow (point, start_distance, end_distance, alpha) {
	
		var stroke_width = 0.2
	
		//			__1__ 	Main Line
		var line = extrapolate_line (point, start_distance, end_distance, alpha)
		var sp_x = line.start [0]
		var sp_y = line.start [1]
		
		var ep_x = line.end [0]
		var ep_y = line.end [1]
		
		
		
		var line_graphic = makeSVG('line', {"class": "graphic", x1: sp_x, y1: sp_y, x2: ep_x, y2: ep_y, stroke: 'white', 'stroke-width': stroke_width});
		$("#canvas").append (line_graphic)
		
			
		//			__2__ 	Arrow Line A 
		var arrow_1 = extrapolate_line (line.end, 1, 8, alpha - 2.5) 
		
		var sp_x = arrow_1.start [0]
		var sp_y = arrow_1.start [1]
		
		var ep_x = arrow_1.end [0]
		var ep_y = arrow_1.end [1]
		
		line_graphic = makeSVG('line', {"class": "graphic",x1: sp_x, y1: sp_y, x2: ep_x, y2: ep_y, stroke: 'white', 'stroke-width': stroke_width});
		$("#canvas").append (line_graphic)
		
		
		//			__3__ 	Arrow Line B 
		var arrow_2 = extrapolate_line (line.end, 1, 8, alpha + 2.5) 
		
		var sp_x = arrow_2.start [0]
		var sp_y = arrow_2.start [1]
		
		var ep_x = arrow_2.end [0]
		var ep_y = arrow_2.end [1]
		
		line_graphic = makeSVG('line', {"class": "graphic",x1: sp_x, y1: sp_y, x2: ep_x, y2: ep_y, stroke: 'white', 'stroke-width': stroke_width});
		$("#canvas").append (line_graphic)
	}
	/////////////////////////////////////////////////////
	
	
	
	
	
	////////////////////////////////////////////////
	function assign_hit_range (item_list) {
		var counter = 0
		for (item of item_list) {
			item.hit_range = []
			if (item.hit_chance != "r") {
				
				for (var i = 0; i < item.hit_chance; i++) {
				item.hit_range.push (counter)
				counter += 1
				}
			}
			else {
				for (counter ; counter < 100; counter ++) {
					item.hit_range.push (counter)
				}
			}
		}
	}
	/////////////////////////////////////////////////
	
	
	
	////////////////////////
	function get_hit_zone () {
		var hit_zones = {
			"0-29": "b",
			"30-79": "be",
			"80-97": "t",
			"98-99": "ct"
		}
		
		var r = Math.floor (100 * Math.random () )
		
		return between_dict (hit_zones, r)
	}
	
	
	
	
	
	
	var basic_hit_chance = {
		1000: 100,
		2000:90,
		3000:80,
		4000:70,
		5000:60,
		6000:50,
		7000:45,
		8000:35,
		9000:25,
		10000:20,
		11000:18,
		12000:17,
		13000:16,
		14000:15,
		15000:15,
		16000:14,
		17000:13,
		18000:12,
		19000:11,
		20000:10,
		21000:9,
		22000:8,
		23000:8,
		24000:7,
		25000:7,
		26000:6,
		27000:5,
		28000:4,
		29000:3,
		30000:3
	}
	
	
	

	
	
	
	function point_distance (a,b) {
		var dx = a [0] - b [0]
		var dy = a [1] - b [1] 
		
		return Math.sqrt ( dx * dx + dy * dy) 
	}
	
	
	
	
	function rad_to_grad (x) {
		x = 3.14 - x 
		x = x * 57.324
		x = Math.round (x)
		return x
	}
	
	function set_set_direction_knob (theta) {
		var display_y = Math.cos (theta) * 30 + 40 - 5 
		var display_x = Math.sin (theta) * 30 + 42 - 5
		display_x = Math.floor (display_x)
		display_y = Math.floor (display_y)
		$("#point_set").css ("top", display_y).css ("left", display_x) 
	}
	
	function set_current_direction_knob (theta) {
		
		
		var display_y = Math.cos (theta) * 18 + 40 - 5 
		var display_x = Math.sin (theta) * 18 + 42 - 5
		display_x = Math.floor (display_x)
		display_y = Math.floor (display_y)
		$("#point_current").css ("top", display_y).css ("left", display_x) 
	}
	
	
	
	app.controller ("mainController", function ($scope, $rootScope) { 
		//  ##main
		
		//	ship design 
		$scope.ship_name = ''
		$scope.tonnage = 10000
		$scope.free_tonnage = 0
		$scope.d_speed = 20
		$scope.belt_armor = 0
		$scope.belt_armor_tonnage = 0 
		$scope.deck_armor = 0
		$scope.deck_armor_tonnage = 0 
		$scope.ct_armor = 0
		$scope.ct_armor_tonnage = 0 
		$scope.d_main_gun = 11
		$scope.main_gun_per_turret = 2
		$scope.main_turret_list = [ ]
		$scope.main_turret_tonnage_naked = 0
		$scope.main_turret_tonnage_total = 0
		$scope.main_turret_armor = 0
		$scope.main_turret_armor_tonnage = 0
		//	------------
		
		
		$scope.turn_message_list = []
		$scope.turn_shot_list = []
		//	Display Options 
		$scope.target_lines_display_options = "all"
		$scope.display_target_lines_fleets = []
		
		
				// Available Ships
		$scope.available_ship_list = available_ship_list
		$scope.player_ship = CONCORDIA
		
		
		$scope.delete = function (x) {
			$scope.main_turret_list.remove (x) 
		}
		
		$scope.alertx = function (stuff) {
			alert (stuff) 
		}
		
		$scope.switch_shot_display = function (shot) {
			if (shot.display == false ) {shot.display = true}
			else {shot.display = false}
			console.log (shot)
		}
		
		$scope.enlarge_escort_radius = function (fleet) {
			fleet.escort_radius += 10; 
		}
		
		$scope.decrease_escort_radius = function (fleet) {
			fleet.escort_radius -= 10; 
		}
		
		////////////////////////////////////////////
		$scope.escort_display_send_to_middle = function (fleet,number) {
			var sides = ['f', 'r', 'a', 'l'];
			var new_list = []; 
			for (let side of sides) {
				// alert (fleet.escort_ships [side].length); 
				var side_length = fleet.escort_ships [side].length; 
				var percentage_length = Math.ceil (side_length * number); 
				// alert (percentage_length);
				for (var i = 0; i < percentage_length; i++) {
					// alert (side + "  " + i +  "   removing ship"); 
					var ship_to_remove = fleet.escort_ships [side] [0]; 
					fleet.escort_ships [side].remove (ship_to_remove);
					new_list.push (ship_to_remove); 
				}
			}
			
			fleet.escort_ships ["selected"] = fleet.escort_ships ["selected"].concat (new_list);
		}
		///////////////////////////////////////////////
		
		$scope.create_flottila = function (fleet) {
			var new_flottila = new $scope.fleet_factory ({
				name:"flottila", 
				position: fleet.position.slice (0), 
				team: fleet.team, 
				graphic_symbol:"yellow_button.png", 
				fleet_type: "flottila"
				}); 
				
			for (let item of fleet.escort_ships ["selected"]) {
				new_flottila.core_ship_list.push (item); 
			}  
				
			if (fleet.team = "p") {
				$scope.player_fleet_list.push (new_flottila);
			} 
			
			if (fleet.team = "e") {
				$scope.enemy_fleet_list.push (new_flottila);
			} 
		
		}
		
		////////////////////////////////////////////////////
		////////////////// 		TURRET Object 		///////
		///////////////////////////////////////////////////
		$scope.turret_factory = function (data, parent) {
			this.data = data
			this.parent = parent 
			
			this.armor = this.data.armor
			this.type = this.data.type
			this.category = this.data.category
			this.gun_number = data.gun_number
			this.cal = this.data.cal 
			this.rof = Math.floor (30 / this.cal)
			this.damage = this.cal ** 2 / 10 
			this.max_hitpoints = this.cal ** 3 / 1000 
			this.current_hitpoints = this.max_hitpoints  
			this.hit_chance = 3
			this.arc = this.data.arc 
			
			this.hit_range = []
			this.status = "ok"  // ok -> functional ;; ld -> light damage ;; hd --> heavy damage ;; j --> junk ;; g --> gone 
			this.ok_the_round_before = true
			
			
			
			this.fire = function (distance,target) {
				
				//		check if the turret is still functional 
				if (this.ok_the_round_before != true) {
					// // $scope.turn_message_list.push ("turret cannot fire :: DAMAGED ")
					return false 
				}
				
				//		check if the target is in turret arc 
				if (this.parent.fleet.turrets_in_arc [this.arc] == false) {
					return false
				}
				
				var hits = 0
				
				
				var shots_fired = Math.floor (this.gun_number * this.rof)
				this.parent.fleet.shots_fired_this_turn += 1; 
				
				var damage = this.damage
				
				
				///// create the shots 
				for (var i = 0; i < shots_fired; i++) {
				
					var shot = {}
					shot.mothership = this.parent.name 
					shot.target_name = target.name 
					shot.caliber = this.cal 
					shot.distance = distance 
					shot.events = [] 
					shot.display = false; 
					shot.p = {	// Probability 
						"result" : 1, 
						"mods" : []
					}
					
					
					var pen = 4 * this.cal 
					
					shot.pen = {
						"result" : pen, 
						"mods" : [
							"start:  " + pen 
						]
					}
					
					// 			Distance to hit penalty and Distance penetration penalty 
					pen = pen - (distance / 1000)
					
					var distance_to_hit_mod = 225 / ( this.cal ** 2)   
					
					p = 1 - (distance * distance_to_hit_mod / 30000 )
					
					shot.p.result = p; 
					shot.p.mods.push ("Distance: " +p)
					
					shot.pen.result = pen; 
					shot.pen.mods.push ("Distance:  " + pen); 
					
					dice = Math.random () 
					shot.dice = dice 
					
					if ( p > dice ) {
						
						// dice = Math.random () 
						//		check vertical hit
						
						
						var target_components = target.elements
						///////////////////////////  remove components whose damage state is "j" (Junk) 
						for (let item of target_components.slice()) 
						{
							if (item.status == "j") 
							{
								target_components.remove (item) 
							}
						}
					
						
						assign_hit_range (target_components)
						
						
						var n = random_n (99) 
						
						for (let item of target_components) {
							if ( item.hit_range.includes (n) ) {
								$scope.turn_message_list.push ( [target.name + "  " + item.type +  "  hit " + pen, "{ }"])
								item.process_damage ({
									pen : pen,
									damage : damage,
									hit_angle : this.parent.fleet.target_hit_angle,
									hit_side : this.parent.fleet.target_hit_side,
									shot : shot})
							}
						
						}
						
						
						hits += 1; 
					}
				}
				
				
				this.parent.last_turn_hits += hits
				this.parent.last_turn_shots_fired += shots_fired 
				this.parent.overall_hits += hits
				this.parent.overall_shots_fired += shots_fired 
			
			
			}
			
			
			
			/////////////////////////////////
			this.process_damage = function (args) {
				var pen = args.pen 
				var damage = args.damage 
				var hit_angle = args.hit_angle 
				var hit_side = args.hit_side 
				var shot = args.shot; 
				
				
				this.parent.fleet.damage_report ["hits_taken"] += 1; 
				
				if (pen >= this.armor)  {
					this.parent.fleet.damage_report ["armor_penetrated"] += 1; 
					$scope.turn_message_list.push ( [ this.parent.name + "  turret  damaged",  "{'font-size':'10px', 'color':'grey' }"      ] )
					shot.events.push ([ this.category + "  turret armor penetrated"    ,"{'font-size':'10px', 'color':'aqua' }"      ]); 
					this.current_hitpoints -= damage; 
					var cm = this.current_hitpoints / this.max_hitpoints 
					if (cm < 0.5 ) { this.status ="hd"}
					if (this.current_hitpoints <= 0 ) 
					{
						this.status = "j"		// "j"   stands for "JUNK" 
						// alert (this.data.category) 
						switch (this.data.category) {
							case "s": 
								this.parent.fleet.damage_report ["secondaries_destroyed"] += 1 
								break; 
							case "m": 
								this.parent.fleet.damage_report ["main_destroyed"] += 1 
								break; 
						}
						
						
					}
					// if (cm <= -10) {this.status = "g"}
				} else {
					shot.events.push ([ this.category + "  turret armor deflected"    ,"{'font-size':'10px', 'color':'grey' }"      ]); 
				}
				$scope.turn_shot_list.push (shot); 
				
				
			}
			///////////////////////////////
			
			this.update = function () {
				if (this.status != "ok") {
					this.ok_the_round_before = false 
				}
			}
			
		}
		
		////////////////////////////////////
		////////////////// 		END : 		TURRET Object 		
		///////////////////////////////////////////////////
	
	
	
		////////////////////////////////////////////////////
		////////////////// 		MAIN_BODY		Object 		///////
		///////////////////////////////////////////////////
		$scope.main_body_factory = function () {
			this.parent = parent 
			this.type = "belt" 
			this.armor = this.parent.data.armor 
			
			 
			this.hit_chance = "r"
			this.hit_range = []
			
			////////////////////////////////////////
			this.ship_explosion = function () {
				$("#middle_column").append (   $("<img></img)").attr ("src", "ex4.gif").addClass ("fleet_a").addClass ("explosion").addClass ("small_explosion").css ("position", "absolute"  ).css ("top",Math.floor (this.parent.fleet.position [1]) - 50 +"px").css ("left",Math.floor (this.parent.fleet.position [0]) -42 +"px")    )
			}
			////////////////////////////////////////
			
			
			
			
			
			this.process_damage = function (args) {
				var pen = args.pen 
				var damage = args.damage 
				var hit_angle = args.hit_angle 
				var hit_side = args.hit_side 
				var shot = args.shot; 
				 
				
				
				var relevant_armor = this.parent.data.armor [hit_side]
				
				this.parent.fleet.damage_report ["hits_taken"] += 1; 
				
					var pen_90 = pen 
					var angle_factor = Math.max (hit_angle / 1.57, 0.5)
					pen = xround (angle_factor * pen, 1) 
					shot.pen.mods.push ('angled_hit  ' + pen); 
					$scope.turn_message_list.push ([ pen_90 + "    " + pen           ,"{'font-size':'10px', 'color':'blue' }"      ]) 
				
			
			
				if (pen >= relevant_armor) {
					this.parent.fleet.damage_report ["armor_penetrated"] += 1;
					this.parent.fleet.damage_report ["damage_taken"] += damage; 
					$scope.turn_message_list.push ([ "main_armor penetrated"    ,"{'font-size':'10px', 'color':'orange' }"      ]) 
					shot.events.push ([ "main_armor penetrated"    ,"{'font-size':'10px', 'color':'orange' }"      ]); 
					
					var n = Math.random ()
					
					if (n < 0.3) {
						this.parent.current_engine_hitpoints -= damage
						this.parent.engine_hitpoints_q = xround (40 * this.parent.current_engine_hitpoints / this.parent.max_engine_hitpoints, 0)
						$scope.turn_message_list.push ([this.parent.name + "  engine hit    " , "{'font-size':'10px', 'color':'purple' }"      ])
						shot.events.push ([this.parent.name + "  engine hit    " , "{'font-size':'10px', 'color':'purple' }"      ])
						if ((this.parent.current_engine_hitpoints <= 0) && (this.parent.status == "ok") ) {
							
							this.parent.die () 
							
							$scope.turn_message_list.push ([this.parent.name + "  Engine Explosion, SHIP DESTROYED    " , "{'font-size':'20px', 'color':'red' }"      ]) 
							shot.events.push ([this.parent.name + "  Engine Explosion, SHIP DESTROYED    " , "{'font-size':'20px', 'color':'red' }"      ]) 
							
							
							
							
							
						}
						
					} else {
						this.parent.hitpoints -= damage // 
						this.parent.hitpoints_q = xround ( 40 * this.parent.hitpoints / this.parent.max_hitpoints, 0)
						
						
						$scope.$apply;
						if ( (this.parent.hitpoints <= 0 ) && (this.parent.status == "ok")) {
							this.parent.die ()
							$scope.turn_message_list.push ([this.parent.name + "  Structure Destroyed, SHIP DESTROYED    " , "{'font-size':'20px', 'color':'red' }"      ]) 
							shot.events.push ([this.parent.name + "  Structure Destroyed, SHIP DESTROYED    " , "{'font-size':'20px', 'color':'red' }"      ]) 
							
						
						}
					}
					
				
				} else {
					shot.events.push ([ "Deflected by main armor"    ,"{'font-size':'10px', 'color':'grey' }"      ]); 
				}
				
				$scope.turn_shot_list.push (shot); 
			
			}
			
		}
	
	
		///////////////////
		////////////////// 		END : 		MAIN_BODY 	 Object 		
		///////////////////////////////////////////////////
		
		
	
		////////////////////////////////////////////////////
		////////////////// 		Ship Object 		///////
		///////////////////////////////////////////////////
		$scope.ship_factory = function (data) {
			this.data = data 
			this.status = "ok"
			this.name = this.data.name; 
			this.type = this.data.type; 
			this.hitpoints = this.data.hitpoints; 
			this.max_hitpoints = this.hitpoints 
			this.hitpoints_q = 40
			
			
			
			
			this.max_engine_hitpoints = this.hitpoints / 10 
			this.current_engine_hitpoints = this.max_engine_hitpoints 
			this.engine_hitpoints_q = 40
			this.undamaged_top_speed = this.data.top_speed
			this.actual_top_speed = this.undamaged_top_speed 
			
			//		Guns / Turrets 
			
			this.turret_list = [] 
			for (let item of this.data.turrets) {
				var t = new $scope.turret_factory ( item /*data*/ , this /*parent*/ )
				this.turret_list.push (t)
			}
			
			
			// 
			
			
			this.fleet = false   /// Parent Fleet 
			this.enemy_ship_list = [] 
			this.target = false
			this.target_distance = 0 
			this.last_turn_hits = "none"
			this.last_turn_shots_fired = "none"
			this.overall_hits = 0 
			this.overall_shots_fired = 0 
			
			
			
			
			
			//  	// 
			
			
			
			
			this.main_body = new $scope.main_body_factory (armor = this.data.armor, parent = this)
			
			//		// 
			
			
			
			this.elements = [].concat (this.turret_list, [this.main_body]   )
			
			////////////////////////////////////////
			this.ship_explosion = function () {
				$("#middle_column").append (   $("<img></img)").attr ("src", "ex4.gif").addClass ("fleet_a").addClass ("explosion").addClass ("small_explosion").css ("position", "absolute"  ).css ("top",Math.floor (this.fleet.position [1]) - 50 +"px").css ("left",Math.floor (this.fleet.position [0]) -42 +"px")    )
							
			
			}
			////////////////////////////////////////
			
			
			////////////////////////////////////////   ship - die 
			this.die = function () {
				this.status = "dead"
				switch (this.data.category) {
					case "BB": 
						this.fleet.damage_report ["battleships_destroyed"] += 1
						break;
				}
				
				
				this.ship_explosion () 
				
				this.fleet.remove_ship (this)
				
				
				
				
			}
			///////////////////////////////////////////////
			
			
			////////////////////////////////////////////////
			this.update_enemy_ship_list = function () {
				this.enemy_ship_list = [] 
				
				
				if (this.fleet.team == "p") {
					var opponent_fleet_list = $scope.enemy_fleet_list  
					
				}
				else if (this.fleet.team =="e") {
					var opponent_fleet_list = $scope.player_fleet_list 
					
				}
				else { alert ("fucked up")}
				
				/// 
				
				for ( var i = 0; i < opponent_fleet_list.length ; i++) {
					var f = opponent_fleet_list [i] 
					for (var j  = 0; j <  f.core_ship_list.length; j++) {
						this.enemy_ship_list.push (f.core_ship_list [j]) 
					}
				}
			}
			//////////////////////
			
			this.select_target = function () {
				if (this.enemy_ship_list.length > 0 ) {
					this.target = this.enemy_ship_list [0]
				} else {
					this.target = false 
				}
			}
			////////////////////
			this.update_turrets = function () {
				
				
				for ( let t of this.turret_list) {
					
					t.update ()
					if (t.status == "ok") {
					
					}
				}
				
				
			}
			
			////////////////////
			this.update_secondary_guns = function () {
				if (this.secondary_turret_list != [] ) {
			
					var new_turrets = []
					this.secondary_guns.n = 0
					for ( var i = 0; i< this.secondary_turret_list.length; i++) {
						t = this.secondary_turret_list [i] 
						if (t.status != "g") {
							new_turrets.push (t)
						}
						
						if (t.status == "ok") {
						this.secondary_guns.n += t.gun_number 
						}
					}
					
					
					this.secondary_turret_list = new_turrets
				}
			}
			
			////////////////////////////
			this.update_engines = function () {
				var health_ratio = this.current_engine_hitpoints / this.max_engine_hitpoints 
				if (health_ratio < 0 ) {health_ratio = 0 }
				this.actual_top_speed = Math.round ( health_ratio * this.undamaged_top_speed)
			}
		
			
			//////////////////////////////////////////////////////////////////////////////////////////////////////////
			this.fire = function () {
				
				if (this.target == false) {
					return false 
				}
				
				
				//		a) 		preliminaries
				this.last_turn_hits = 0 
				this.last_turn_shots_fired = 0 
				
				//		b)		get target distance 
				var distance = point_distance (this.fleet.position, this.target.fleet.position)
				
				// 		get display target_distance 
				this.target_distance = Math.ceil ((distance) * 100 )
				distance = Math.ceil (distance / 10) * 1000
				// var p = basic_hit_chance [distance] / 100
				
				
				for (let item of this.turret_list) {
					item.fire (distance = distance, target = this.target )
				}
				
				
				$scope.turn_message_list.push ([this.name + "   shots fired :  " + this.last_turn_shots_fired , "{'font-size':'10px', 'color':'white' }"      ] )
				
				$scope.turn_message_list.push (["hits  " +this.last_turn_hits, "{'font-size':'10px', 'color':'white' }"      ])
				
				
				
				
				
				
				$scope.$apply ()
					
			}
			/////////////////////////////////////////// 						////////////////////////////////
			
			this.update = function (parent_fleet) {
				
				this.fleet = parent_fleet 
				
				
				
				this.update_enemy_ship_list ()
				this.select_target ()
				
				
				
			}
			
			this.update_2 = function () {
				
				this.fire (m_s ="m")
				
				
				/*
				if (! this.secondary_turret_list.equals  ([]) ) {
					this.fire (m_s ="s")
				}
				*/
			}
			
			this.update_3 = function () {
				this.update_turrets ()
				
				
				this.update_engines ()
				$scope.$apply ()
				
			
			}
			this.update_turrets ()
			
			
			
			
			
		}
		////////////////////////////////////
		////////////////// 		END : 		Ship Object 		
		///////////////////////////////////////////////////
	
		/////////////////////////////////////////////////////////
		////////////////// 		Fleet Object  	/////////////////
		/////////////////////////////////////////////////////////
		$scope.fleet_factory = function (args) {
		
			this.set_course = 1.57 
			this.current_course = 1.57
			this.man = 1
			this.speed = 25
			this.position = args.position
			this.name = args.name
			this.fleet_type = args.fleet_type
			this.escort_radius = 50 
			this.core_ship_list = []
			this.escort_ships = {
				f: [], 
				r: [],
				a: [],
				l: [], 
				selected: []
			}
			this.team = args.team 
			
			this.graphic_symbol = args.graphic_symbol 
			this.target_fleet = 'na'
			this.target_angle = 'na'
			this.target_hit_angle = 'na'
			this.target_hit_side = 'na'
			this.turrets_in_arc = {
				"cx":'na',
				"f":'na',
				"a":'na',
				'bl':'na',
				'br':'na'
			}
			this.status = 'ok'
			this.shots_fired_this_turn = 0 
			this.damage_report_zero = {
				"hits_taken" : 0, 
				"armor_penetrated" : 0, 
				"damage_taken": 0, 
				"main_destroyed": 0, 
				"secondaries_destroyed": 0, 
				"battleships_destroyed": 0 
			}
			
			
			
			
			//////////////////////////
			/*
			this.fleet.core_ship_list.remove (this)
				this.fleet.ring_ship_list.remove (this)
			*/
			this.remove_ship = function (ship) {
				this.core_ship_list.remove (ship)
				this.escort_ships.f.remove (ship)
				this.escort_ships.r.remove (ship)
				this.escort_ships.a.remove (ship)
				this.escort_ships.l.remove (ship)
				
				
				if (this.core_ship_list.length == 0) {
					this.die () 
				}
			}
			/////////////////////////
			
			
			///////////////////////////////////////
			this.die = function () {
				$scope.player_fleet_list.remove (this) 
				$scope.enemy_fleet_list.remove (this) 
				$scope.fleets_died_this_turn.push (this)
				
				if ($scope.active_player_fleet == this) {
					$scope.active_player_fleet = false 
				}
			
				if ($scope.active_enemy_fleet == this) {
					$scope.active_enemy_fleet = false 
				}
			}
			///////////////////////////////////////
			
			
			///////////////////////////////////////
			this.normalize_angle = function (a) {
				if (a < -3.14) {
					a += 6.28
				}
				if (a > 3.14) {
					a -= 6.28
				}
				return a 
			}
			///////////////////////////////////////
			
			
			
			
			///////////////////////////////////////
			this.update_course = function () {
				var sa = this.set_course - this.current_course 
				
				if ( Math.abs (sa) < this.man ) {
					this.current_course = this.set_course 
				}
				
				else {
					if (sa < 0) {
						sa += 6.28;
					}
					if (sa > 6.28) {
						sa -= 6.28;
					}
					
					var act = this.current_course
					var set = this.set_course
					
					if (  sa <= 3.14 ) {
						this.current_course += this.man 	
					}
					if (sa > 3.14) {
						this.current_course -= this.man 	
					}
				}
				
				this.current_course = this.normalize_angle (this.current_course)
			
			}
			/////////////////////////
			
			
			this.update_target_distance = function () {
			
				//		Get target course
				var a = this.current_course
				
				var ps = this.position 
				var pe = this.target_fleet.position 
				
				 
				
				var rel_pos = vsub (pe, ps) 
				this.target_distance = vector_length (rel_pos)  // target distance 
				this.target_distance = (xround (this.target_distance, 2)); 
				
			}
			
			///////////////////////////////////////
			this.update_top_speed = function () {
				
				if (this.core_ship_list.length > 0) {
					this.top_speed = 1000 
					for (let s of this.core_ship_list) {
						if (s.actual_top_speed < this.top_speed ) {
							this.top_speed = s.actual_top_speed 
						}
						
					}
				}
				
				if (this.speed > this.top_speed ) {
					this.speed = this.top_speed 
				}
			
			}
			///////////////////////////////////////
			
			////////////////////////////////
			this.update_target_angle = function () {
			
				//		Get target course
				var a = this.current_course
				
				var ps = this.position 
				var pe = this.target_fleet.position 
				
				var rel_pos = vsub (pe, ps) 
				var b = Math.atan2 (rel_pos [0], rel_pos [1])
				
				//		Get relative angle 
				var alpha = b - a 
				
				if (alpha < 0) {
					alpha += 6.28
				}
			
				if (alpha > 6.29) {
					alpha -= 6.28
				}
				
				alpha = xround (alpha, 3)
				
				this.target_angle = alpha
				this.target_angle_degree = xround (57.3 * alpha, 0)
				
				
				//		check if target in turret arcs 
						//		coax
						
				if ( (alpha < 10 / 57.3) || (alpha > 350 / 57.3)) {
					this.turrets_in_arc.cx = true
				} else {
					this.turrets_in_arc.cx = false 
				}
				
				
						//		fore: 
				if ( (alpha < 135 / 57.3 ) || (alpha > 225 / 57.3)) {
					this.turrets_in_arc.f = true
				} else {
					this.turrets_in_arc.f = false
				}
						// aft: 
				if (  (alpha > 45 / 57.3) && (alpha < 315 / 57.3)) {
					this.turrets_in_arc.a = true
				} else {
					this.turrets_in_arc.a = false
				}
						// broadside left 
				if ( (alpha > 45 / 57.3) && (alpha < 135 / 57.3)) {
					this.turrets_in_arc.bl = true
				} else {
					this.turrets_in_arc.bl = false 
				}
						// broadside right
				if ( (alpha > 225 / 57.3 ) && (alpha < 315 / 57.3)) {
					this.turrets_in_arc.br = true
				} else {
					this.turrets_in_arc.br = false 
				}
				
				// 		get target_hit_angle 
				
				this.target_hit_angle = b - this.target_fleet.current_course 
				
							// 		Get hit side 
							
				var ha = this.target_hit_angle 
				var hit_side = "none"
							
									// Front
				if ( (ha <= -2.618) || (ha >= 2.618)) {
					hit_side = "f"
				} 
									// Left
				else if ( (ha >= -2.618) && (ha <= -0.524) ) {
					hit_side = "l"
				} 
									// Aft
				else if ( (ha > -0.524) && (ha <= 0.524)         ) {
					hit_side = "a"
				}
									// Right 
				else if ( (ha >= 0.524) && (ha <= 2.618)        ) {
					hit_side = "r"
				}
				
				else { 
					alert ("fucked up hit_side")
				}
					
				this.target_hit_side = hit_side
							
							

							
							
							// 		Get obliquity 
				
				
				this.target_hit_angle = Math.abs (this.target_hit_angle)
				if (this.target_hit_angle > 3.14) {
					this.target_hit_angle -= 3.14
				}
				if (this.target_hit_angle > 1.57) {
					this.target_hit_angle = 3.14 - this.target_hit_angle 
				}
				this.target_hit_angle = xround (this.target_hit_angle, 3) 
			}
			///////////////////////////////////////
			
			////////////////////////////
			this.escort_circle_graphics = function () {
				
				// var stroke_width = (Math.floor ( this.ring_ship_list.length ** 0.5) ) / 5
				// var stroke_width = 0.5
				var distance = this.escort_radius; 
				
				
				
				
				//		
						// point_1 
				var sides_list = [
									{"side": "f", "angle": 0, "color": "yellow"},
									{"side": "r", "angle": 90, "color": "orange"},
									{"side": "a", "angle": 180, "color": "red"},
									{"side": "l", "angle": 270, "color": "aqua"},
								]
				
				for (let item of sides_list) {
					
					var stroke_width = (Math.floor ( this.escort_ships[item.side].length ** 0.5) ) / 5
				
				
					var middle_angle = angle_go_left (this.current_course, item.angle /57.3) 
					var alpha = angle_go_left (middle_angle, 40 / 57.3) 
					var point_1 = vround (extrapolate_line (this.position, 0, distance, alpha).end,0 )
					var point_1_s = point_to_string (point_1) 
					
					
						// point_2 
					var alpha = angle_go_right (middle_angle, 40 / 57.3) 
					var point_2 = vround (extrapolate_line (this.position, 0, distance, alpha).end,0) 
					var point_2_s = point_to_string (point_2)
					
						// 
					var test = makeSVG ('path', {"class":"graphic",d: "M" + point_1_s +" A" +distance +"," + distance + " 20 0,1 " +point_2_s, stroke: item.color, 'stroke-width': stroke_width, fill: 'rgba(100,255,100,0'} )
					test.classList.add (this.name)
					$("#canvas").append (test)
				
				}
			}
			///////////////////////////
			
			
			///////////////////////////
			this.main_fleet_graphics = function () {
				//			__a__ 	create fleet dot and append it to middle_column 
				var new_element = $("<div> </div>").addClass ("fleet_button").css ("top", this.position [1] + "px").css ("left", this.position [0] + "px") .addClass ("graphic").css ("background-image", "url('"+ this.graphic_symbol +"')").addClass (this.name)
				
				
				$("#middle_column").append ( new_element) 
				
				//			__b__ 	mark the activ fleet 
				if (this == $scope.active_player_fleet) {
					var new_cover = $("<div> </div>").addClass ("fleet_button").css ("top", this.position [1] + "px").css ("left", this.position [0] + "px") .addClass ("graphic").css ("background-image", "url('trans_white_button.png')").addClass (this.name).addClass ("player_active_fleet_marker")
					
					$("#middle_column").append ( new_cover) 
				}
				
				if (this == $scope.active_enemy_fleet) {
					var new_cover = $("<div> </div>").addClass ("fleet_button").css ("top", this.position [1] + "px").css ("left", this.position [0] + "px") .addClass ("graphic").css ("background-image", "url('trans_white_button.png')").addClass (this.name).addClass ("enemy_active_fleet_marker")
					
					$("#middle_column").append ( new_cover) 
				}
			}
			
			
			
			///////////////////////////
			
			
			///////////////////////////
			this.do_graphics = function () {
				draw_speed_arrow ( this.position , 9 ,9 +  this.speed * 1.5, this.current_course )
				this.escort_circle_graphics () 
				
				if (this.team == 'p') {
					for (let item of $scope.enemy_fleet_list) {
						draw_target_line (this, item, $scope)
					}
				}
				
				this.main_fleet_graphics ()
			}
			///////////////////////////
			
			///////////////////////////
			this.update_ships  = function () {
				var escort_list = concat_object_values (this.escort_ships); 
				var complete_ship_list = this.core_ship_list.concat (escort_list)
				for (let item of complete_ship_list) {
					item.update (this);
				}
			}
			///////////////////////////
			
			///////////////////////////
			this.update_ships_2 = function () {
				var escort_list = concat_object_values (this.escort_ships); 
				var complete_ship_list = this.core_ship_list.concat (escort_list)
				for (let item of complete_ship_list) {
					item.update_2 ()
				}
			}
			///////////////////////////
			
			///////////////////////////
			this.update_ships_3 = function () {
				var escort_list = concat_object_values (this.escort_ships); 
				var complete_ship_list = this.core_ship_list.concat (escort_list)
				for (let item of complete_ship_list) {
					item.update_3 ()
				}
			}
			///////////////////////////
			
			///////////////////////////
			this.fleet_main = function (active) {
				this.shots_fired_this_turn = 0 
				
				this.damage_report = jQuery.extend  (true, {}, this.damage_report_zero)
				if (this.core_ship_list.equals ([])) {
					this.status = 'dead'
					this.position = [-1000,-1000]
					
				
				} 
				
				if (this.status == 'ok') {
				
					this.update_ships () 	// calls the update functions on all the fleets ships 
					// this.update_ships_2 ()
					this.update_top_speed ()
					
					this.update_course ()
					this.position [0] += this.speed * 0.3 * Math.sin (this.current_course);
					this.position [1] += this.speed * 0.3 * Math.cos (this.current_course);
					
					
					
					$scope.$apply ()
				
				}
			}
			///////////////////////////
			
			///////////////////////////
			this.fleet_main_2 = function () {
				if (this.team == 'p') {
					this.target_fleet = $scope.enemy_fleet_list [0]
				} else if ( this.team = 'e') {
					this.target_fleet = $scope.player_fleet_list [0]
				} else {
					alert ("fucked up")
				}
				
				this.update_target_angle ()
				this.update_target_distance () 
				this.update_ships_2 ()
			}
			///////////////////////////
			
			//////////////////////////////////
			this.fleet_main_3 = function () {
				for (var i = 0; i < this.shots_fired_this_turn ** 0.01; i++) {
					$("#middle_column").append ($("<div> </div>").addClass ("graphic orange_shot").css ("left", this.position [0] - 7 + randInt (14) + "px").css ("top", this.position [1] - 7 + randInt (14) + "px").animate ({"left":this.target_fleet.position [0] - 7 + randInt (14), "top":this.target_fleet.position [1] - 7 + randInt (14)}, 700, "linear", function () {
						var explosion = $(this).clone() 
						$(explosion).addClass ("small_yellow_ring graphic") 
						$(explosion).removeClass ("orange_shot")
						$("#middle_column").append (explosion)
						$(this).remove ()
					
					} )) 
				}
				
				this.update_ships_3 ()
				
			}
			//////////////////////////////////
			
			//////////////////////////////////		
			this.fleet_main_4 = function () {
				
				this.do_graphics () 
				var display_hits_field = $("<div> </div>")  
				
				$(display_hits_field).css ("left", this.position [0] +  "px").css ("top", this.position [1] + "px").addClass ("b17").addClass ("graphic").addClass ("result_display")  

				var display_item_list = [
					{
						"text" :   "hits" , 
						"variable":   "hits_taken"
					}, 
					{
						"text" :   "pen" , 
						"variable":   "armor_penetrated"
					}, 
					{
						"text" :  "damage"  , 
						"variable":   "damage_taken"
					}, 
					{
						"text" :  "main t destr."  , 
						"variable":   "main_destroyed"
					}, 
					{
						"text" :  "second t destr"  , 
						"variable":   "secondaries_destroyed"
					}, 
					{
						"text" :  "BB destroyed"  , 
						"variable":   "battleships_destroyed" 
					}, 
				]
				
				for (let item of display_item_list) 
				{
					var col = $("<div> </div>").addClass("display_hits_field_column") 
					$(display_hits_field).append (col) 
					
					var col_left = $("<div> </div>").addClass("display_hits_field_column_left").html (item ["text"] + " : " )   
					$(col).append (col_left)
					
					var col_right = $("<div> </div>").addClass("display_hits_field_column_right").html (this.damage_report [item ["variable"]])
					$(col).append (col_right)
					
					// $(display_hits_field).append ($("<div> </div>").html (item ["text"] + " :  " + this.damage_report [item ["variable"]]).addClass("display_hits_field_column") ).
				}
				
				///// .html ("pen: " +this.damage_report ["armor_penetrated"])

				
				
				
				$("#middle_column").append (display_hits_field)
			
			}
			//////////////////////////////////
			
			//////////////////////////////////
			this.cleanup_graphics = function () {
				console.log ("cleanup funtion has been executed  " + this.name)
				$("." + this.name).remove ()
			}
			//////////////////////////////////
			
			//////////////////////////////////
			this.init = function () {
				this.update_top_speed ()
				
				this.do_graphics () 
			}
			//////////////////////////////////
			
			
		
			
			
		}
		///////////////////////////////////////////
		//////////////////////////////////////////		END 	Fleet Object 
		/////////////////////////////////////////////////////////////////////////////////////
		$scope.fleets_died_this_turn = []
		
		$scope.player_fleet_list = []
		
		$scope.enemy_fleet_list = []
		
		$scope.fleet_a = new $scope.fleet_factory ({
			name:"fleet_a",
			position : 	[450, 300],
			team : "p",
			graphic_symbol :"green_button.png",
			fleet_type : "main"
			}) 
		$scope.player_fleet_list.push ($scope.fleet_a)
		
		$scope.fleet_b = new $scope.fleet_factory ( {
			name: "fleet_b",
			position: [600, 300],
			team : "p",
			graphic_symbol : "green_button.png",
			fleet_type : "main"
			}) 
		$scope.player_fleet_list.push ($scope.fleet_b)
		
		
		// $scope.fleet_b = new $scope.fleet_factory ("fleet_b")
		// $scope.fleet_c = new $scope.fleet_factory ("fleet_c")
		
		
		// $scope.player_fleet_list.push ($scope.fleet_b)
		// $scope.player_fleet_list.push ($scope.fleet_c)
		
		
		
		
		
		$scope.fleet_x = new $scope.fleet_factory ({
			name: "fleet_x", 
			position: [200,300],
			team : "e", 
			graphic_symbol : "red_button.png",
			fleet_type : "main"
			})
		$scope.enemy_fleet_list.push ($scope.fleet_x)
		
		
		for (let item of $scope.player_fleet_list.concat ($scope.enemy_fleet_list) ) {
			item.init () 
		}
		
		
		
		$scope.fleet_y = new $scope.fleet_factory ({
			name: "fleet_y", 
			position: [200,500],
			team : "e",
			graphic_symbol : "red_button.png",
			fleet_type : "main"
			})
		$scope.enemy_fleet_list.push ($scope.fleet_y)
		
		
		for (let item of $scope.player_fleet_list.concat ($scope.enemy_fleet_list) ) {
			item.init () 
		}
		
		
		$scope.active_player_fleet = $scope.fleet_a 
		$scope.active_enemy_fleet = $scope.fleet_x
		
		////////////////////////////////////	////////////////////////////	///////////////////////////
		///////////////////////////////////		START : Assign ships to fleets 	///////////////////////////
		///////////////////////////////////		////////////////////////////	///////////////////////////
		
		
		///			Fleet_a 	
			
		s = new $scope.ship_factory (CONCORDIA)
		$scope.fleet_a.core_ship_list.push (s) 
		
				//		Escort ships 	
		for (var i = 0; i < 30; i++) {
			s = new $scope.ship_factory ( HORNET)
			$scope.fleet_a.escort_ships.f.push (s) 
		}	
		
		for (var i = 0; i < 5; i++) {
			s = new $scope.ship_factory ( HORNET)
			$scope.fleet_a.escort_ships.l.push (s) 
		}	
		
		for (var i = 0; i < 2; i++) {
			s = new $scope.ship_factory ( HORNET)
			$scope.fleet_a.escort_ships.r.push (s) 
		}	
		
		for (var i = 0; i < 10; i++) {
			s = new $scope.ship_factory ( HORNET)
			$scope.fleet_a.escort_ships.a.push (s) 
		}	
		
		///			Fleet_b
		for ( var i = 0; i < 2; i++) {
			s = new $scope.ship_factory (CONCORDIA)
			$scope.fleet_b.core_ship_list.push (s) 
		}
		
		
		
		///			Fleet_x 
		
		for (var i=0; i < 3; i++) {
			s = new $scope.ship_factory ( FRALTHI)
			$scope.fleet_x.core_ship_list.push (s) 
		}
		
		///			Fleet_y 
		
		for (var i=0; i < 1; i++) {
			s = new $scope.ship_factory (FRALTHI)
			$scope.fleet_y.core_ship_list.push (s) 
		}
		
		
		
		
		
		
		
		////////////////////////////////////	////////////////////////////	
		///////////////////////////////////		END : Assign ships to fleets 	///////////////////////////
		///////////////////////////////////		////////////////////////////	
		
		
		
		
		
		$scope.direction_knob = function (event) {
			
			var x = event.pageX - $(event.target).offset ().left - 41
			var y = event.pageY - $(event.target).offset ().top  - 40
			
			var theta = Math.atan2 (x,y)
			$scope.active_player_fleet.set_course = theta 
			// $scope.$apply ()	
		}
		
		
		
		////////////////////////
		
		/////////////////////////
		$("#turn_button").on ("click", function () {
			console.clear ()
			
		
			$scope.update_display_lines ($scope.target_lines_display_options)
			$scope.fleets_died_this_turn = []
			// remove explosion animations from the last turn 
			$(".explosion").remove ()
			$(".graphic").remove ()
			
			
			$scope.turn_message_list = []
			//////////////////////////
			
			$scope.turn_shot_list = [] 
	
			var complete_list = $scope.player_fleet_list.concat ($scope.enemy_fleet_list) 
			
			for (var i = 0; i < complete_list.length; i++) {
				var active = false 
				if (complete_list [i] == $scope.active_player_fleet) {
					active = true
				}
				complete_list [i].fleet_main (active)
			}
			
			for (var i = 0; i < complete_list.length; i++) {
				complete_list [i].fleet_main_2 ()
			}
			
			for (var i = 0; i < complete_list.length; i++) {
				complete_list [i].fleet_main_3 ()
			}
			
			for (let item of complete_list) {
				item.fleet_main_4 ()
			}
			
			for (let item of $scope.fleets_died_this_turn) {
				item.cleanup_graphics ()
			}
			
			$scope.$apply();
		});
		///////////////////////////////////////
		
		///////////////////////////////////////
	
		///////////////////////////////////////
		
		///////////////////////////////////////
		$("#play_this_ship_button").on ("click", function () {
			$scope.new_ship = {} 
			
			$scope.new_ship.name = $scope.ship_name
			$scope.new_ship.type = "UD" 
			$scope.new_ship.top_speed = $scope.d_speed
			$scope.new_ship.hitpoints = 0
			$scope.new_ship.secondary_turrets = {}
			$scope.new_ship.main_turrets = []
			for (let item of $scope.main_turret_list) {
				var new_turret = {}
				new_turret.cal = $scope.d_main_gun
				new_turret.gun_number = $scope.main_gun_per_turret 
				new_turret.hitpoints = xround (new_turret.cal ** 2.5 / 100 , 2)
				
				new_turret.armor = $scope.main_turret_armor
			
				new_turret.arc = item.arc
				$scope.new_ship.main_turrets.push (new_turret)
			}
			$scope.new_ship.belt_armor = $scope.belt_armor
			$scope.new_ship.deck_armor = $scope.deck_armor
		
		
			$scope.new_ship.secondary_armor = 0 
			
			$scope.new_ship.superstructure = [ 
				{
				"armor":$scope.ct_armor,
				"name": "ct",
				"hit_chance":3, 
				"hit_points":10,
				"bridge": true, 
				"bridge_hit_chance": 20, 
				"director":true,
				"director_hit_chance":10
				},
				{
				"armor":0,
				"name": "s2",
				"hit_chance":10, 
				"hit_points":30,
				"bridge": true, 
				"bridge_hit_chance": 10, 
				"director":true,
				"director_hit_chance":5
				
				}  
			]
			
			
			s = new $scope.ship_factory ($scope.new_ship)
			$scope.fleet_a.core_ship_list = []
			$scope.fleet_a.core_ship_list.push (s) 
			
			
			
		})
		
		
		
		
		/////////
		$("#up").on ("click", function () {
			$scope.active_player_fleet.set_course -= 0.01745
			$scope.$apply ()
			
			
		
		})
		//////////
		
		
		$("#down").on ("click", function () {
			$scope.active_player_fleet.set_course += 0.01745
			$scope.$apply ()
			
		})
		
		$scope.update_display_lines = function (newVal) {
			switch (newVal) {
				case 'all': 
					$scope.display_target_lines_fleets = $scope.player_fleet_list.concat ($scope.enemy_fleet_list) 
					break;
				case 'active_fleet':
					$scope.display_target_lines_fleets = [$scope.active_player_fleet].concat ($scope.enemy_fleet_list) 
					break;
				case 'selected_enemy':
					$scope.display_target_lines_fleets = [$scope.active_player_fleet, $scope.active_enemy_fleet]
					break;
				case 'none': 
					$scope.display_target_lines_fleets = []
					break;
			}
		
		}
		
		
		
		
		
		//////////    WATCH
		//////////
		
		//////////		set_course 
		$scope.$watch ( function ($scope) {
				return $scope.target_lines_display_options 
			},
			function  (newVal, oldVal, $scope)  {
				$scope.update_display_lines (newVal) 
				
				
			}, true)
		////////////
		
		
		
		///////////		set_course 
		$scope.$watch ( function ($scope) {
				return $scope.active_player_fleet.set_course
			},
			function  (newVal, oldVal, $scope)  {
				$("#display_set_course").html ("set: <br>" + rad_to_grad (newVal))
				set_set_direction_knob (newVal)
			}, true)
		////////////
		
		
		///////////		current_course
		$scope.$watch ( function ($scope) {
				return $scope.active_player_fleet.current_course   // experimental   true value: $scope.active_player_fleet.current_course
			},
			function  (newVal, oldVal, $scope)  {
				$("#display_current_course").html ("current: <br>" + rad_to_grad (newVal))
				set_current_direction_knob (newVal)
			}, true)
		////////////
		
		
		
		/////////////// SHIP DESIGN 
		$scope.$watch ('[d_speed,tonnage ]', function (newVal, odlVal, $scope) {
			$scope.engine_tonnage = 0.01 * $scope.tonnage * $scope.d_speed
		}, true
		)
		
		$scope.$watch ('[engine_tonnage,belt_armor_tonnage,deck_armor_tonnage,tonnage,ct_armor_tonnage,main_turret_tonnage_total ]', function (newVal, odlVal, $scope) {
			$scope.free_tonnage = $scope.tonnage * 0.9 - $scope.engine_tonnage -$scope.belt_armor_tonnage -$scope.deck_armor_tonnage  -$scope.ct_armor_tonnage -$scope.main_turret_tonnage_total 
		}, true
		)
		
		
		$scope.$watch ('[belt_armor,tonnage ]', function (newVal, odlVal, $scope) {
			$scope.belt_armor_tonnage = 0.01 * $scope.tonnage * $scope.belt_armor 
		}, true
		)
		
		$scope.$watch ('[deck_armor,tonnage ]', function (newVal, odlVal, $scope) {
			$scope.deck_armor_tonnage = 0.01 * $scope.tonnage * $scope.deck_armor 
		}, true
		)
		
		$scope.$watch ('[ct_armor ]', function (newVal, odlVal, $scope) {
			$scope.ct_armor_tonnage = 50 * $scope.ct_armor 
			
		}, true
		)
		
		$scope.$watch ('[d_main_gun_cal, main_gun_per_turret, main_turret_list  ]', function (newVal, odlVal, $scope) {
			
			$scope.main_turret_tonnage_naked = Math.floor ($scope.main_turret_list.length * $scope.main_gun_per_turret * $scope.d_main_gun_cal ** 2); 
			
		}, true
		)
		
		
		
		//
		$scope.$watch ('[main_turret_armor, d_main_gun_cal, main_gun_per_turret, main_turret_list]', function (newVal, odlVal, $scope) {
			
			var turret_size = $scope.main_turret_list.length * $scope.main_gun_per_turret * $scope.d_main_gun_cal ** 2 
			
			$scope.main_turret_armor_tonnage = Math.floor (0.1 * turret_size * $scope.main_turret_armor); 
			
			
			
		}, true
		)
		
		
		//
		
		$scope.$watch ('[main_turret_armor_tonnage,main_turret_tonnage_naked]', function (newVal, odlVal, $scope) {
			$scope.main_turret_tonnage_total = Math.floor ($scope.main_turret_tonnage_naked + $scope.main_turret_armor_tonnage ); 
			
		}, true
		)
		
		$scope.$watch ('[player_ship]', function (newVal, oldVal, $scope) {
			$scope.fleet_a.core_ship_list = []
			s = new $scope.ship_factory ( $scope.player_ship)
			$scope.fleet_a.core_ship_list.push (s)
		
		}
		)
		
		
		
		
		$(document).ready ( function () {
		
			$("#middle_column").on ("click", function (event) {
				
			
				var clickpoint = [event.clientX -$(this).offset().left, event.clientY - $(this).offset().top]
				for (let item of $scope.player_fleet_list) {
					if ( point_distance (clickpoint, item.position) <= 10) {
						$scope.active_player_fleet = item 
						$scope.$apply ();
						// $("." + item.name).remove ()
						$(".player_active_fleet_marker").remove ()
						item.do_graphics ()
					}
				}
				for (let item of $scope.enemy_fleet_list) {
					if ( point_distance (clickpoint, item.position) <= 10) {
						$scope.active_enemy_fleet = item 
						$scope.$apply ();
						// $("." + item.name).remove ()
						$(".enemy_active_fleet_marker").remove ()
						item.do_graphics ()
					}
				}
				
			}  ) 
		
			$("#add_main_turret").on ("click", function () {
				var x_pos = $(this).offset ().left
				var y_pos = $(this).offset ().top + $(this).height ()
				var container = $("<div> </div>") 
				$(container).css ("position", "relative" ).css ("width", "194px").css ("background-color", "white").css ("box-sizing", "border-box").css ("margin", "3px").css ("overflow-y", "hidden").css ("margin-left", "200px")
				$("#add_main_gun_wrapper").append (container)
				
				var turret_option_list = [
					{"name":"A", "arc":"f"},
					{"name":"B", "arc":"f"},
					{"name":"C", "arc":"f"},
					{"name":"W", "arc":"a"},
					{"name":"X", "arc":"a"},
					{"name":"Y", "arc":"a"}
				 ] 
				for (let item of turret_option_list) {
					if (! $scope.main_turret_list.includes (item)) {
						var list_element = $("<div> </div>")
						$(list_element).html (item.name).css ("border", "1px solid grey").css ("padding-left", "5px")
						$(container).append (list_element)
						$(list_element).on ("click", function () {
							$scope.main_turret_list.push_x ( item ) 
							$(this).parent ().remove ()
							$scope.$apply ()
						}   )
					}
				}
				
			
			}  )
		
		
		}  ) 
		
			
			
		
		
	
				//////////////////////////
	})			////////////////////////// 		END 	CONTROLLER
				//////////////////////////
		
	
	
	
	
	</script>
	
	
	<script> 
	
		
	
	
	</script>
	
	
	
	<script>
		
	
	
		$(document).ready ( function () {
			$("*").css ("box-sizing", "border-box");
			$("#design_frame").hide ()
			
			$("#battle_button").on ("click", function () {
				$(".battle_design_frame").hide () 
				$("#battle_frame").show () 
			
			}  )
			
			$("#design_button").on ("click", function () {
				$(".battle_design_frame").hide () 
				$("#design_frame").show () 
			}  )
			
			
			/////
			$("body").on("keypress", function (e) {
				var key = e.originalEvent.charCode; 
				if (key == 32) {
					$(".b17").remove ()
				}
				
				
			});
			
			/////
			
			
		})
		
	
	
	</script>

</head>
<body ng-app="mainApp" ng-controller="mainController" assign-commands> 
	<div id="windows_frame"> 
		<div id="inner_windows_frame"> 
			<div id="main_menu_bar" class="header_bar"> 
				<div class="menu_button" id="battle_button"> Battle </div>
				<div class="menu_button" id="design_button"> Design </div>
				
			</div>
			<div class="black_line_h"> </div>
			<div class="battle_design_frame" id="design_frame"> 
				<div class="design_column" id="design_column_1"> <!--  		COL 	1  		--> 
					<div class="column_row"> 		
						<div class="row_field"> Name </div>
						<input type="text" class="row_field" id="tonnage" ng-model="ship_name"> </input>
						
					</div>
				
					<div class="column_row"> 		
						<div class="row_field"> Tonnage: </div>
						<input type="number" step="100" class="row_field" id="tonnage" ng-model="tonnage"> </input>
						<div class="row_field"> Free:  </div>
						<div class="row_field">  {{free_tonnage}} &nbsp t </div>
					</div>
					<div class="column_row"> 
						<div class="row_field" > Speed </div>
						<input type="number" class="row_field" ng-model="d_speed" min="5"> </input>
						<div class="row_field" > Engine </div>
						<div class="row_field" > {{engine_tonnage}} &nbsp t</div>
					</div>
					<div style="width:100%;height:20px;"> </div>
					<div class="column_row"> 
						<div class="row_field" > Belt Armor </div>
						<input type="number" class="row_field" ng-model="belt_armor"> </input>
						<div class="row_field" > {{belt_armor_tonnage}} &nbsp t</div>
					</div>
					<div class="column_row"> 
						<div class="row_field" > Deck Armor </div>
						<input  type="number" class="row_field" ng-model="deck_armor"> </input>
						<div class="row_field" > {{deck_armor_tonnage}} &nbsp t</div>
					</div>
					<div class="column_row"> 
						<div class="row_field" > Ct Armor </div>
						<input  type="number" class="row_field" ng-model="ct_armor"> </input>
						<div class="row_field" > {{ct_armor_tonnage}} &nbsp t</div>
					</div>
				</div> 		<!-- 	End 	COL 1 	-->
				<div class="design_column_spacer"> </div>
				<div class="design_column" id="design_column_2">  <!-- Column 2 --> 
					<div class="column_row"> 		
						<div class="row_field"> Main Turrets </div>
						
					</div>
					<div class="column_row"> 		
						<div class="row_field"> Gun Caliber  </div>
						<!-- <input type="number" min="2" class="row_field" ng-model="d_main_gun_cal">   </input> -->
						<select class="row_field" ng-model="d_main_gun_cal">   
							<option ng-value="6"> 6  </option>
							<option ng-value="8"> 8  </option>
							<option ng-value="11"> 11 </option>
							<option ng-value="15"> 15 </option>
						</select>
						<div class="row_field" > Guns / Turret  </div>
						<input type="number" min="1" class="row_field" ng-model="main_gun_per_turret">   </input>
					</div>
					
					
					<div id="add_main_gun_wrapper" style="width:100%;height:20px;display:block;flex-direction:column;"> <!-- Dropdown wrapper --> 
						<div class="column_row"> 	
							<div class="row_field">   </div>
							<div class="row_field">   </div>
							<button class="row_field" id="add_main_turret"> Add Turret </button>
						</div>
					</div>
					
					<div class="column_row" ng-repeat="turret in main_turret_list"> 		
						<div class="row_field" style="display:flex;flex-direction:row;"> {{turret}} 
							<div style="width:0px;flex-grow:1;height:100%;"> </div>
							<button t={{turret}}  style="width:20px;height:100%;background-color:grey;color:red;border-radius:10px;padding-left:4px;" ng-click="delete (turret)"> &times </button>
						</div>
					</div>
					
					<div style="display:flex;flex-direction:row;width:100%;border:1px solid red;"> 
					
						<div style="display:flex;flex-direction:column;width:200px;border:1px solid green;"> 
					
					
							<div class="column_row"> 
								<div class="row_field" style="width:200px;">  TURRET WEIGHT </div>
							</div>
							
							<div class="column_row"> 
								<div class="row_field"> Naked </div>
								<div class="row_field"> {{main_turret_tonnage_naked}} </div>
							</div>
							
							
							<div class="column_row"> 
								<div class="row_field"> Total </div>
								<div class="row_field"> {{main_turret_tonnage_total}} </div>
							</div>
					
						</div>
						
						
						<div style="display:flex;flex-direction:column;width:300px;border:1px solid green;"> 
					
					
							<div class="column_row"> 
								<div class="row_field" style="width:200px;">  TURRET ARMOR </div>
							</div>
							
							<div class="column_row"> 
								<div class="row_field"> Armor </div>
								<input class="row_field" ng-model="main_turret_armor" type="number">  </input>
								<div class="row_field"> {{main_turret_armor_tonnage}}  &nbsp t</div>
							</div>
							
							
							
					
						</div>
					</div>
					

				</div>   <!-- 	End 	COL 2 	-->
				<div class="design_column_spacer"> </div>
				<div class="design_column" id="design_column_3">
					<button class="column_row" id="play_this_ship_button" > Play this ship</button>
				</div>
			
			</div>
			<div class="battle_design_frame" id="battle_frame">
		
				<div id="header_row"> 
					<div class ="header_bar" id="header_upper_bar"> 
						<div id="turn_button"> Turn </div>
						
						<select id="select_ship" ng-model="player_ship" ng-options="item as item.name for item in available_ship_list">
						<option value="" disabled selected> Select Ship</option>
							
						
						</select>
						<div> {{player_ship.name}} </div>
						
						<form style="border:1px solid black;"> 
							<input type="number" name="x"> x </input>
							<input type="number" name="y"> y </input>
							<input type="button" onclick="dot([this.form.x.value,this.form.y.value])"> click </input>
						
						</form>
						<select id="select_ship" ng-model="target_lines_display_options" ng-options="item as item for item in ['all', 'active_fleet','selected_enemy', 'none']">
						</select>
					</div>
					<div class ="header_bar" id="header_lower_bar"> 
						<div class="ship_display_small" ng-repeat="ship in active_player_fleet.core_ship_list">
							<div class="ship_display_inner"> 
								<div>{{ship.name}} </div>
								<div class="small_bar">
									<div class="small_bar_inner" health-bar  > </div>
								</div>
								<div class="small_bar">
									<div class="small_bar_inner" engine-bar style="background-color:blue;"  > </div>
								</div>
							</div>
							<div class="ship_display_inner">
								<div class="turret_display" > 
									<div class="cx_turret_ok" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='cx')&&(turret.status=='ok')"> </div>
									<div class="cx_turret_dead" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='cx')&&(turret.status!='ok')"> </div>
									
								</div>
								
								<div class="turret_display" > 
									<div class="main_turret_ok" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='m')&&(turret.status=='ok')"> </div>
									<div class="main_turret_dead" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='m')&&(turret.status!='ok')"> </div>
									
								</div>
								
								<div class="turret_display" > 
									<div class="secondary_turret_ok" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='s')&&(turret.status=='ok')"> </div>
									<div class="secondary_turret_dead" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='s')&&(turret.status!='ok')"> </div>
								</div>
								
							</div>
						</div>
					</div>
					
				</div>
				<div class="black_line_h"> </div>
				<div id="middle_row">
					<div id="left_column"> 
						<div id="direction_speed_container"> 
							<div style="flex-grow:1"> </div>
							<div id="select_direction" ng-click="direction_knob ($event)"> 
								<div id="point_set"> </div>
								<div id="point_current"> </div>
							</div>
							<div style="flex-grow:1"> </div>
							<div id="display_course_number" >
								<div id="display_current_course"> </div>
								<div id="display_set_course"> </div>
							</div>
							<div style="flex-grow:1"> </div>
							<div id="up_down">
								<div id="up"> </div>
								<div style="flex-grow:1"> </div>
								<div id="down"> </div>
							</div>
							<div style="flex-grow:1"> </div>
						</div>
						<div class="black_line_h"> </div>
						<div id="player_ship_list"> 
							<div class = "ship_display" ng-repeat="fleet in player_fleet_list">
								<div class="name_type">
									<div class="name"> {{fleet.name}}</div>
								</div>
								<div class="hp" style="width:100%;height:20px;"> {{fleet.target_fleet.name}} </div>
								<div class="hp" style="width:100%;height:20px;"> target angle: {{  fleet.target_angle_degree}} </div>
								<div class="hp" style="width:100%;height:20px;"> hit angle: {{  fleet.target_hit_angle}} </div>
								<div class="hp" style="width:100%;height:20px;"> Distance:  {{fleet.target_distance}} </div>
								
								<div class="arc" style="width:100%;height:20px;"> coax arc:
									<div class="green_light"  ng-if="fleet.turrets_in_arc.cx" > </div>
									<div class="red_light"  ng-if="!fleet.turrets_in_arc.cx" > </div>
								</div>
								<div class="arc" style="width:100%;height:20px;"> fore arc:
									<div class="green_light"  ng-if="fleet.turrets_in_arc.f" > </div>
									<div class="red_light"  ng-if="!fleet.turrets_in_arc.f" > </div>
								</div>
								<div class="arc" style="width:100%;height:20px;"> aft arc: 
									<div class="green_light"  ng-if="fleet.turrets_in_arc.a" > </div>
									<div class="red_light"  ng-if="!fleet.turrets_in_arc.a" > </div>
								</div>
								<div class="hp" style="width:100%;height:20px;"> br right arc: {{fleet.turrets_in_arc.br}} </div>
								<div class="hp" style="width:100%;height:20px;"> br left arc: {{fleet.turrets_in_arc.bl}} </div>
							<div class="escort_display"> 
								<div class="escort_display_distance">
									<div class="escort_display_distance_number"> {{fleet.escort_radius}} </div>
									<div class="escort_display_distance_number" ng-click="enlarge_escort_radius (fleet)"> + </div>
									<div class="escort_display_distance_number" ng-click="decrease_escort_radius (fleet)"> - </div>
								</div>
								
								<div class="escort_display_send_to_middle"> 
									<div class="escort_display_send_to_middle_number" ng-click="escort_display_send_to_middle (fleet, 0.25)"> 25 </div>
									<div class="escort_display_send_to_middle_number" ng-click="escort_display_send_to_middle (fleet, 0.50)"> 50 </div>
									<div class="escort_display_send_to_middle_number" ng-click="escort_display_send_to_middle (fleet, 0.75)"> 75 </div>
									<div class="escort_display_send_to_middle_number" ng-click="escort_display_send_to_middle (fleet, 1)"> All </div>
								</div>
								
								<div class="escort_display_top_row">
									<div class="escort_display_symbol" ng-repeat="escort in fleet.escort_ships.f" > </div>
								</div>
								<div class="escort_display_middle_row"> 
									<div class="escort_display_left_column"> 
										<div class="escort_display_symbol" ng-repeat="escort in fleet.escort_ships.l" > </div>
									</div>
									<div class="escort_display_middle_column"> 
										<div class="escort_display_middle_column_top_row">
											<div class="escort_display_symbol" ng-repeat="escort in fleet.escort_ships.selected" > </div>
										</div>
										<div class="escort_display_middle_column_bottom_row">
											<div class="escort_display_create_flottila_button" ng-click="create_flottila (fleet)"> Create Flottila</div>
										</div>
									</div>
										<div class="escort_display_right_column"><div class="escort_display_symbol" ng-repeat="escort in fleet.escort_ships.r" > </div>
									</div>
								</div>
								<div class="escort_display_bottom_row">
									<div class="escort_display_symbol" ng-repeat="escort in fleet.escort_ships.a" > </div>
								</div>
								
							</div>
							
							
							</div>
						</div>

					</div>
					<div class="black_line_v"> </div>
					<div id="middle_column"> 
						<svg  id="canvas" height="1000" width="1000">
						  Sorry, your browser does not support inline SVG.
						</svg>
						
						
					</div>
					<div class="black_line_v"> </div>
					
					<div id="right_0_column"> 
						<div class="column_row" ng-repeat="m in turn_message_list.slice (0,20) track by $index" ng-style={{m[1]}}  style="font-size:10pt;" > {{m [0]}}  </div>  <!-- ng-style={{m[1]}} --> 
					</div>
					
					<div class="black_line_v"> </div>
					<div id="right_column" style="font-size:10px;">
						<div  ng-repeat="shot in turn_shot_list.slice (0,20) track by $index"  style="border:1px ridge blue;display:flex;flex-direction:column;font-size=10px;" > 
							<div class="column_row" style="font-size:10px"> 
								{{shot.target_name + "  hit by  " +   shot.mothership + "  cal  " +shot.caliber}} 
								<div style="margin-left:7px;background-color:white;color:red;border-radius:8px;border:1px solid white;" ng-click="switch_shot_display (shot)"> {{(shot.display ? "-" : "+")}} </div>
							</div>  
							<div class="column_row" ng-repeat="e in shot.events track by $index" ng-style={{e[1]}} >  {{e [0]}}   </div> 
							<div ng-if="shot.display">  
								<div > {{shot.p.mods}}
								</div> 
								<div> {{shot.pen.mods}} </div> 
							</div> 
						</div> 
					</div>
				</div>
				<div class="black_line_h"> </div>
				<div id="footer_row">
					<div class="ship_display_small" ng-repeat="ship in active_enemy_fleet.core_ship_list">
						<div class="ship_display_inner"> 
							<div>{{ship.name}} </div>
							<div class="small_bar">
								<div class="small_bar_inner" health-bar  > </div>
							</div>
							<div class="small_bar">
								<div class="small_bar_inner" engine-bar style="background-color:blue;"  > </div>
							</div>
						</div>
						<div class="ship_display_inner"> 
							<div class="turret_display" > 
								<div class="cx_turret_ok" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='cx')&&(turret.status=='ok')"> </div>
								<div class="cx_turret_dead" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='cx')&&(turret.status!='ok')"> </div>
								
							</div>
							
							<div class="turret_display" > 
								<div class="main_turret_ok" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='m')&&(turret.status=='ok')"> </div>
								<div class="main_turret_dead" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='m')&&(turret.status!='ok')"> </div>
								
							</div>
							
							<div class="turret_display" > 
								<div class="secondary_turret_ok" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='s')&&(turret.status=='ok')"> </div>
								<div class="secondary_turret_dead" ng-repeat="turret in ship.turret_list" ng-if="(turret.category=='s')&&(turret.status!='ok')"> </div>
							</div>
						</div>
					</div>

				</div>
			</div> <!-- END : inner Windows frame --> 
		</div>
	</div>

	
	
	


</body>


</html>
